name: Deploy Web App
on:
  push:
    branches: [master]
 
jobs:
  build:
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v2
      
      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login --username "${{ secrets.DOCKER_USERNAME }}" --password-stdin docker.io
      
      - name: Build Docker image
        run: docker build -t cygnetops/web-app-test -f Dockerfile.dev .
      
      - name: Run tests
        run: docker run -e CI=true cygnetops/web-app-test npm test
      
      - name: Generate deployment package (zip)
        run: zip -r /home/wauser/deploy.zip . -x '*.git*'
    

  deploy:
    needs: build
    runs-on: self-hosted
    steps:
      - uses: actions/checkout@v2

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login --username "${{ secrets.DOCKER_USERNAME }}" --password-stdin docker.io
      
      # Add deploy steps here
      - name: Copy deployment package to Nginx server container
        run: docker cp /home/wauser/deploy.zip web_app-web_app_server-1:/usr/share/nginx/html/deploy.zip

      - name: Extract deployment package on Nginx server container
        run: docker unzip -o /usr/share/nginx/html/deploy.zip web_app-web_app_server-1:/usr/share/nginx/html/
      
      - name: Restart Nginx service
        run: sudo service nginx restart